<div class="post-detail-container">
  <!-- Header -->
  <app-navbar></app-navbar>

  <!-- Post Content -->
  @if(post()){
  <div class="post-content">
    <article class="post-article">
      <!-- Post Header -->
      <header class="article-header">
        <div class="header-content">
          <h1 class="article-title">{{ post()!.title }}</h1>
          <div class="header-actions">
            <button mat-icon-button [matMenuTriggerFor]="postMenu">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #postMenu="matMenu">
              @if(isAuthor()){
              <button mat-menu-item (click)="editPost()">
                <mat-icon>edit</mat-icon>
                <span>Edit Post</span>
              </button>
              <button mat-menu-item (click)="deletePost()">
                <mat-icon>delete</mat-icon>
                <span>Delete Post</span>
              </button>
              }@else{
              <button mat-menu-item (click)="reportPost()">
                <mat-icon>flag</mat-icon>
                <span>Report</span>
              </button>
              }
              <button mat-menu-item (click)="copyLink()">
                <mat-icon>link</mat-icon>
                <span>Copy Link</span>
              </button>
            </mat-menu>
          </div>
        </div>

        <div class="article-meta">
          <div class="author-info">
            <img
              [src]="post()!.author.avatar ? post()!.author.avatar : 'default-avatar.png'"
              [alt]="post()!.author.username"
              class="author-avatar"
              (click)="viewProfile(post()!.author.username)"
            />
            <div class="author-details">
              <div class="author-name" (click)="viewProfile(post()!.author.username)">{{ post()!.author.username }}</div>
              <div class="publish-info">
                <span>{{ post()!.publishedDate }}</span>
                <span class="separator">•</span>
                <span>{{ readTime() }} min read</span>
              </div>
            </div>
          </div>
          @if(!isAuthor()){
          <app-follow
            [username]="post()!.author.username"
            [isFollowing]="isFollowing()"
            (followChange)="onFollowChange($event)"
          >
          </app-follow>
          }
        </div>
      </header>

      <!-- Featured Image -->
      <div class="featured-image">
        <img [src]="post()!.thumbnail" [alt]="post()!.title" />
      </div>

      <!-- Article Content -->
      <div class="article-content">
        <div class="article-body" [innerHTML]="safeContent"></div>
      </div>

      <!-- Engagement Actions -->
      <div class="engagement-section">
        <div class="engagement-actions">
          <button
            mat-button
            class="engagement-btn"
            [class.liked]="isLiked()"
            (click)="toggleLike()"
          >
            <mat-icon>{{ isLiked() ? 'favorite' : 'favorite_border' }}</mat-icon>
            <span>{{ post()!.likes }}</span>
          </button>

          <button mat-button class="engagement-btn" (click)="scrollToComments()">
            <mat-icon>comment</mat-icon>
            <span>{{ post()!.comments }}</span>
          </button>
        </div>
      </div>
    </article>

    <!-- Author Profile Card -->
    <mat-card class="author-card">
      <div class="author-card-content">
        <img
          [src]="post()!.author.avatar ? post()!.author.avatar : 'default-avatar.png'"
          [alt]="post()!.author.username"
          class="author-card-avatar"
          (click)="viewProfile(post()!.author.username)"
        />
        <div class="author-card-info">
          <h3 class="author-card-name" (click)="viewProfile(post()!.author.username)">{{ post()!.author.username }}</h3>
          <p class="author-card-bio">
            {{ post()!.author.bio ? post()!.author.bio : 'No bio yet' }}
          </p>

          <div class="author-stats">
            <span>{{ post()!.author.followers }} Followers</span>
            <span class="separator">•</span>
            <span>{{ post()!.author.following }} Following</span>
          </div>
        </div>
        @if(!isAuthor()){
        <app-follow
          [username]="post()!.author.username"
          [isFollowing]="isFollowing()"
          (followChange)="onFollowChange($event)"
        >
        </app-follow>
        }
      </div>
    </mat-card>

    <!-- Comments Section -->
    <div class="comments-section" id="comments">
      <h3 class="comments-title">Comments ({{ post()!.comments }})</h3>

      <div class="comment-form">
        <textarea
          [(ngModel)]="newCommentText"
          placeholder="Share your thoughts..."
          rows="3"
        ></textarea>
        <button mat-raised-button (click)="addComment()" class="comment-button">
          Post Comment
        </button>
      </div>

      <div class="comments-list">
        @for(comment of Comments(); track comment.id){
        <div class="comment">
          <img
            [src]="comment.avatar ? comment.avatar : 'default-avatar.png'"
            [alt]="comment.username"
            class="comment-avatar"
            (click)="viewProfile(comment.username)"
          />
          <div class="comment-content">
            <div class="comment-header">
              <div>
                <span class="comment-author" (click)="viewProfile(comment.username)">{{ comment.username }}</span>
                <span class="comment-date">{{ comment.formatedCreatedAt }}</span>
              </div>
              @if(comment.isOwner){
              <button mat-icon-button [matMenuTriggerFor]="commentMenu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #commentMenu="matMenu">
                <button mat-menu-item (click)="editComment(comment.id, comment.content)">
                  <mat-icon>update</mat-icon>
                  <span>Update</span>
                </button>
                <button mat-menu-item (click)="deleteComment(comment.id)">
                  <mat-icon>delete</mat-icon>
                  <span>Delete</span>
                </button>
              </mat-menu>
              }
            </div>
            @if(editingCommentId === comment.id) {
            <div class="comment-edit-form">
              <textarea [(ngModel)]="commentText" rows="3" class="edit-textarea"></textarea>
              <div class="comment-edit-actions">
                <button mat-button color="primary" (click)="updateComment()">Save</button>
                <button mat-button (click)="cancelEdit()">Cancel</button>
              </div>
            </div>
            } @else {
            <p class="comment-text">{{ comment.content }}</p>
            }
          </div>
        </div>
        }

        <!-- Loading more comments -->
        @if(isLoadingMore()) {
        <div style="text-align: center; padding: 20px">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading more comments...</p>
        </div>
        }

        <!-- End of comments message -->
        @if(!hasMore() && Comments() && Comments()!.length > 10) {
        <div style="text-align: center; padding: 20px; color: #666">
          <p>No more comments to load</p>
        </div>
        }
      </div>
    </div>
  </div>
  } @if(postNotFound()){
  <div class="not-found-container">
    <div class="content">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h1>404</h1>
      <h2>Post Not Found</h2>
      <p>Oops! The Post you're looking for doesn't exist.</p>
      <div class="actions">
        <button mat-raised-button color="primary" (click)="goHome()">
          <mat-icon>home</mat-icon>
          Back to Home
        </button>
        <button mat-stroked-button color="accent" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          Go Back
        </button>
      </div>
    </div>
  </div>
  }
</div>
