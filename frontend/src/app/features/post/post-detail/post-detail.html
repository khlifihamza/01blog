<div class="post-detail-container">
  <!-- Header -->
  <mat-toolbar class="post-header">
    <div class="header-content">
      <button mat-icon-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <div class="header-actions">
        <!-- <button mat-icon-button (click)="toggleBookmark()">
          <mat-icon [class.bookmarked]="post()!.isBookmarked">
            {{ post()!.isBookmarked ? 'bookmark' : 'bookmark_border' }}
          </mat-icon>
        </button> -->

        <button mat-icon-button [matMenuTriggerFor]="postMenu">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #postMenu="matMenu">
          @if(isAuthor){
          <button mat-menu-item (click)="editPost()">
            <mat-icon>edit</mat-icon>
            <span>Edit Post</span>
          </button>
          <button mat-menu-item (click)="deletePost()">
            <mat-icon>delete</mat-icon>
            <span>Delete Post</span>
          </button>
          }
          <button mat-menu-item (click)="reportPost()">
            <mat-icon>flag</mat-icon>
            <span>Report</span>
          </button>
          <button mat-menu-item (click)="copyLink()">
            <mat-icon>link</mat-icon>
            <span>Copy Link</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </mat-toolbar>

  <!-- Post Content -->
  @if(post()){
  <div class="post-content">
    <article class="post-article">
      <!-- Post Header -->
      <header class="article-header">
        <h1 class="article-title">{{ post()!.title }}</h1>

        <div class="article-meta">
          <div class="author-info">
            <img
              [src]="post()!.author.avatar ? post()!.author.avatar : 'default-avatar.png'"
              [alt]="post()!.author.username"
              class="author-avatar"
              (click)="viewProfile()"
            />
            <div class="author-details">
              <div class="author-name" (click)="viewProfile()">{{ post()!.author.username }}</div>
              <div class="publish-info">
                <span>{{ formatDate(post()!.publishedDate) }}</span>
                <span class="separator">•</span>
                <span>{{ post()!.readTime }} min read</span>
              </div>
            </div>
          </div>

          <button mat-raised-button color="primary" class="follow-btn" (click)="followUser()">
            {{ isFollowing() ? 'Following' : 'Follow' }}
          </button>
        </div>
      </header>

      <!-- Featured Image -->
      <div class="featured-image">
        <img
          [src]="'http://localhost:8080/api/post/file/' + post()!.thumbnail"
          [alt]="post()!.title"
        />
      </div>

      <!-- Article Content -->
      <div class="article-content">
        <div class="article-body" [innerHTML]="safeContent"></div>
      </div>

      <!-- Engagement Actions -->
      <div class="engagement-section">
        <div class="engagement-actions">
          <button
            mat-button
            class="engagement-btn"
            [class.liked]="isLiked()"
            (click)="toggleLike()"
          >
            <mat-icon>{{ isLiked() ? 'favorite' : 'favorite_border' }}</mat-icon>
            <span>{{ post()!.likes }}</span>
          </button>

          <button mat-button class="engagement-btn" (click)="scrollToComments()">
            <mat-icon>comment</mat-icon>
            <span>{{ post()!.comments }}</span>
          </button>
        </div>
      </div>
    </article>

    <!-- Author Profile Card -->
    <mat-card class="author-card">
      <div class="author-card-content">
        <img
          [src]="post()!.author.avatar ? post()!.author.avatar : 'default-avatar.png'"
          [alt]="post()!.author.username"
          class="author-card-avatar"
          (click)="viewProfile()"
        />
        <div class="author-card-info">
          <h3 class="author-card-name" (click)="viewProfile()">{{ post()!.author.username }}</h3>
          <p class="author-card-bio">{{ post()!.author.bio ?  post()!.author.bio : 'No bio yet'}}</p>

          <div class="author-stats">
            <span>{{ post()!.author.followers }} Followers</span>
            <span class="separator">•</span>
            <span>{{ post()!.author.following }} Following</span>
          </div>
        </div>

        <button mat-raised-button color="primary" (click)="followUser()">
          {{ isFollowing() ? 'Following' : 'Follow' }}
        </button>
      </div>
    </mat-card>

    <!-- Comments Section -->
    <div class="comments-section" id="comments">
      <h3 class="comments-title">Comments ({{ post()!.comments }})</h3>

      <div class="comment-form">
        <textarea
          [(ngModel)]="commentText"
          placeholder="Share your thoughts..."
          rows="3"
        ></textarea>
        <button mat-raised-button color="primary" (click)="addComment()">Post Comment</button>
      </div>

      <div class="comments-list">
        @for(comment of Comments(); track comment.id){
        <div class="comment">
          <img
            [src]="comment.avatar ? comment.avatar : 'default-avatar.png'"
            [alt]="comment.username"
            class="comment-avatar"
            (click)="viewProfile()"
          />
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-author" (click)="viewProfile()">{{ comment.username }}</span>
              <span class="comment-date">{{ formatDate(comment.createAt) }}</span>
            </div>
            <p class="comment-text">{{ comment.content }}</p>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
  }
</div>
