<div class="create-blog-container">
  <!-- Header -->
  <app-navbar></app-navbar>
  @if(postNotFound()){
  <div class="not-found-container">
    <div class="content">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h1>404</h1>
      <h2>Post Not Found</h2>
      <p>Oops! The Post you're looking for doesn't exist.</p>
      <div class="actions">
        <button mat-raised-button color="primary" (click)="goHome()">
          <mat-icon>home</mat-icon>
          Back to Home
        </button>
        <button mat-stroked-button color="accent" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
          Go Back
        </button>
      </div>
    </div>
  </div>
  }@else{
  <!-- Main Content -->
  <div class="create-content">
    <div class="header-content">
      <div class="header-left">
        <span class="header-title">Update Your Story</span>
      </div>

      <div class="header-actions">
        <button
          mat-raised-button
          [class.header-button]="isContentValid() && !isLoading()"
          (click)="updatePost()"
          [disabled]="!isContentValid() || isLoading()"
        >
          <mat-icon>publish</mat-icon>
          Update
        </button>
      </div>
    </div>
    <form [formGroup]="postForm" class="blog-form">
      <!-- Title -->
      <mat-form-field appearance="outline" class="title-field">
        <mat-label>Story Title</mat-label>
        <input matInput formControlName="title" placeholder="Tell your story in a few words..." />
        @if(postForm.get('title')?.hasError('required')){
        <mat-error> Title is required </mat-error>
        } @if(postForm.get('title')?.hasError('maxlength')){
        <mat-error> Title must be less than 100 characters </mat-error>
        }
      </mat-form-field>

      <!-- Thumbnail Upload -->
      <div class="media-section">
        <h3>Add Thumbnail(Required)</h3>
        <div class="upload-area" (click)="fileInput.click()" [class.has-media]="thumbnailPreview()">
          <input
            #fileInput
            formControlName="thumbnail"
            type="file"
            accept="image/*"
            (change)="onThumbnailSelect($event)"
            (click)="onThumbnailSelect($event)"
            style="display: none"
          />

          @if(!thumbnailPreview()){
          <div class="upload-placeholder">
            <mat-icon>cloud_upload</mat-icon>
            <p>Click to upload image</p>
            <small>Supports: JPG, PNG, GIF</small>
          </div>
          } @else{
          <div class="media-preview">
            <img [src]="thumbnailPreview()" alt="Preview" />
            <button mat-icon-button class="remove-media" (click)="removeThumbnail($event)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
          }
        </div>
      </div>

      <!-- Content Editor -->
      <div class="content-section">
        <h3>Tell Your Story</h3>
        <div class="editor-container">
          <div
            #editorDiv
            class="editable-content"
            contenteditable="true"
            (input)="onContentChange($event)"
            (keyup)="updateCursorPosition()"
            (mouseup)="updateCursorPosition()"
            (focus)="onFocus()"
            (blur)="onBlur()"
            (paste)="onPaste($event)"
            appDndUpload
            (filesDropped)="onFilesDropped($event)"
            [class.empty]="isContentEmpty()"
            [innerHTML]="safeContent"
          ></div>

          <!-- Floating Add Button -->
          <button
            #addButton
            mat-icon-button
            class="floating-add-btn"
            [style.top.px]="buttonPosition().top"
            [style.left.px]="buttonPosition().left"
            [style.display]="showAddButton() ? 'flex' : 'none'"
            [matMenuTriggerFor]="mediaMenu"
            (click)="onAddClick($event)"
          >
            <mat-icon>add</mat-icon>
          </button>

          <!-- Media Menu -->
          <mat-menu #mediaMenu="matMenu">
            <button mat-menu-item (click)="triggerImageUpload()">
              <mat-icon>image</mat-icon>
              <span>Add Image</span>
            </button>
            <button mat-menu-item (click)="triggerVideoUpload()">
              <mat-icon>videocam</mat-icon>
              <span>Add Video</span>
            </button>
          </mat-menu>

          <!-- Hidden File Inputs -->
          <input
            #imageInput
            type="file"
            accept="image/*"
            style="display: none"
            (change)="handleImageUpload($event)"
          />
          <input
            #videoInput
            type="file"
            accept="video/*"
            style="display: none"
            (change)="handleVideoUpload($event)"
          />
        </div>

        @if(showValidationError()){
        <div class="content-validation">
          <span class="error-text">Content must be at least 100 characters</span>
        </div>
        }
      </div>
    </form>
  </div>
  }
</div>
